#!groovy

def lib = library identifier: 'my-shared-library@master', retriever: modernSCM(github(repository: 'Jenkins', repoOwner: 'SergiiGlad'))

class Sun {   

    String stageName
    String nameSpace
    String releaseName
    String dockerTag

    
    static String getDirName(String yamlFilePath) {
        return yamlFilePath.split('/')[0]
    }
    
    static String getReleaseName(String yamlFilePath) {
        return yamlFilePath.split('/')[1].split(/\./)[0]
    }
    

     Sun(String yamlFilePath) {
        stageName = yamlFilePath
    } 
    
    def initDeploy(String yamlFilePath, String tag) {
        
        nameSpace = getDirName( yamlFilePath )
        releaseName = getReleaseName( yamlFilePath )
        dockerTag = tag
        println("init Deploy")
    }
    

    def print() {
        println(stageName)
        println("k8s_namespace: "+this.nameSpace+
        "\nhelm_release_name: "+this.releaseName+
        "\ndockerTag: "+dockerTag)
    }
    
    def deployStage() {
        println("dockerTag: "+dockerTag)
        if ( dockerTag ) helmDeploy()
    }
    
    def helmDeploy() {
        print()
    }
}


def podLabel = "jenkins-worker-${UUID.randomUUID().toString()}"

properties([
  parameters([
    string(name: 'dockerTag', defaultValue: '', description: 'git tag or short commit from upstream build' )
  ])
])

//helmTemplate(podLabel) {
  node{

    git credentialsId: 'github_git',
      url: 'https://github.com/sergiiglad/web-delivery.git'
    
    // find list yaml files
    def yamlFilePathList = fileList('.')

    if ( yamlFilePathList ) println yamlFilePathList

    // List<SunStage>
    List stages = [] 

    yamlFilePathList.each {
        stages.add( new Sun( it ) )
    }

    stages.each {
      it.print()
      println(it.print().getClass())
    }

    def prodList= []

    // Check changeSet prod release
    prodList = changeSetFiles()

    if ( isShortCommit(params.dockerTag) ) prodList.add( 'develop/dev-web.yaml' )

    if ( isBuildingTag(params.dockerTag) ) prodList.add( 'qa/qa-web.yaml' )

    // mock
    prodList=["prod-us1/web-prod-us1.yaml","prod-us2/web-prod-us2.yaml","develop/dev-web.yaml"] 

    if ( prodList ) println prodList

    stages.each { stage -> 
      prodList.each { prod -> 
          if ( stage.stageName == prod ) 
            if ( prod == 'develop/dev-web.yaml' || prod == 'qa/qa-web.yaml' )
              stage.initDeploy( prod, params.dockerTag ) 
            else
              stage.initDeploy( prod, readYaml(file: prod).image.tag )
            
          
      }
    }
    
    stages.each {
        println("println")
        println it
        it.deployStage()
        it.print()
    }
  }
//}  