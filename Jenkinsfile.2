#!groovy

def lib = library identifier: 'my-shared-library@master', retriever: modernSCM(github(repository: 'Jenkins', repoOwner: 'SergiiGlad'))

def podLabel = "jenkins-worker-${UUID.randomUUID().toString()}"

properties([
  parameters([
    string(name: 'dockerTag', defaultValue: '', description: 'git tag or short commit from upstream build' )
  ])
])

//helmTemplate(podLabel) {
  node(podLabel){

    git credentialsId: 'github_git',
      url: 'https://github.com/sergiiglad/web-delivery.git'
    
    // get classes from share library
    def SunDeploy = lib.com.sun.SunDeploy
    def SunStage = lib.com.sun.SunStage

    // find list yaml files
    def yamlFilePathList = fileList('.')

    if ( yamlFilePathList ) println yamlFilePathList

    // List<SunStage>
    List stages = [] 

    yamlFilePathList.each {
        stages.add( SunStage.new( it ) )
    }

    stages.each {
      it.print()
    }

    // Check changeSet prod release
    def prodList = changeSetFiles()

    if ( prodList) println prodList

    stages.each { stage -> 
      prodList.each { prod -> 
          if ( stage.stageName == prod ) {
              stage.initSunDeploy( prod )
          }    
      }
    }

    stages.each{
        it.deployStage()
    }

    

  }
//}  